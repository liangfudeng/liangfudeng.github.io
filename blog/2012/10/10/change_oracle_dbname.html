<!DOCTYPE html>
<html lang='zh'>
        <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="stylesheet" href="//cdn.static.runoob.com/libs/bootstrap/3.3.7/css/bootstrap.min.css">
    <title>change oracle dbname</title>
</head>

<body>
        <div id="header">
    <nav class="navbar navbar-default" role="navigation">
                <div class="container-fluid">
                        <div class="navbar-header">
                                <a class="navbar-brand" href="/">CLOUD</a>
                        </div>
                        <div class="collapse navbar-collapse" id="example-navbar-collapse">
                                <ul class="nav navbar-nav">
                                        <li><a href="/tweet"><i class="icon-retweet icon-white"></i>Tweets</a></li>
                                        <li><a href="/archive.html"><i class="icon-book icon-white"></i>Archives</a></li>
                                        <li><a href="/category.html"><i class="icon-th-list icon-white"></i>category</a></li>
                                        <li><a href="/about.html"><i class="icon-user icon-white"></i>About</a></li>
                                        <li class="dropdown">
                                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                                        Friend Links <b class="caret"></b>
                                                </a>
                                                <ul class="dropdown-menu">
                                                        <li><a href="http://www.ruanyifeng.com/home.html" target="_blank">阮一峰</a></li>
                                                        <li><a href="http://coolshell.cn/" target="_blank">陈皓haoel</a></li>
                                                        <li><a href="http://www.dbanotes.net/" target="_blank">冯大辉Fenng</a></li>
                                                        <li><a href="http://robbin.iteye.com/" target="_blank">范凯robbin</a></li>
                                                        <li><a href="http://www.eygle.com/" target="_blank">盖国强eygle</a></li>
                                                        <li><a href="http://blog.csdn.net/tianlesoftware" target="_blank">David Dai</a></li>
                                                        <li><a href="http://www.joelonsoftware.com/" target="_blank">Joel Spolsky</a></li>
                                                        <li><a href="http://mindhacks.cn/" target="_blank">刘未鹏MindHacks</a></li>
                                                        <li><a href="http://www.my1510.cn/author.php?roseluqiu" target="_blank">闾丘露薇</a></li>
                                                        <li><a href="http://www.dapenti.com/blog/" target="_blank">铂程斋dapenti</a></li>
                                                </ul>
                                        </li>
                                </ul>
                        </div>
                </div>
        </nav>
</div>


        <div id="content">
                <div class="container">
                        <div class="row">
                                <div>
                                        <div class="entry">
        <div class="entry entry-detail">
                    <div class="entry-header">
                            <h1 class="entry-title">change oracle dbname</h1>
                            <div class="entry-meta">
                                    <span class="entry-by">
                                            <i class="icon-user"></i> <a href="/">dylan</a> on 2012-10-10 14:35:57
                                    </span>
                            </div>
                    </div>
                <div class="entry-content">
                        <p>因新项目开发需要，现需建立新的测试数据库。但目前测试服务器没有到位，故暂且使用以 前的测试机代替，其中安装的Oracle数据库仅作学习测试使用，数据库名、实例名均为 dbtest。现在将此数据库的数据库名、实例名从dbtest改为CRMTEST。</p>
<p>以下是更改记录，以作备忘。</p>
<h2>测试环境</h2>
<ul>
<li>操作系统：CentOS 5.5</li>
<li>数据库: Oracle Database 10.2.0.1.0</li>
</ul>
<h2>主要步骤</h2>
<h3>1. 先更改dbname</h3>
<p>修改oracle数据库的dbid和dbname，主要步骤如下：</p>
<ul>
<li>1)将数据库启动到mount状态：<code>startup mount</code>;</li>
<li>2)使用nid命令修改：<code>nid target=/ DBNAME=CRMTEST</code></li>
<li>3)更改初始化参数文件中的<code>db_name</code>：<code>db_name="CRMTEST"</code></li>
<li>4)启动到mount：<code>startup mount</code></li>
<li>5)以resetlogs打开数据库：<code>alter database open resetlogs</code>;</li>
</ul>
<h4>1)重启数据库到mount</h4>
<p>查看当前数据库names设置：</p>
<pre><code>SQL&gt; show parameter name
NAME                       TYPE      VALUE
-------------------------- --------- ------------------------------
db_file_name_convert       string
db_name                    string    dbtest
db_unique_name             string    dbtest
global_names               boolean   FALSE
instance_name              string    dbtest
lock_name_space            string
log_file_name_convert      string
service_names              string    dbtest
</code></pre>
<p>查看当前数据库启动参数类型：</p>
<pre><code>SQL&gt; show parameter spfile
NAME                       TYPE      VALUE
-------------------------- --------- ------------------------------
spfile                     string     /db/oracle/product/10.2.0/db_1/
                                      dbs/spfiledbtest.ora
</code></pre>
<p>从spfile创建pfile，便于直接编辑参数文件：</p>
<pre><code>SQL&gt; create pfile from spfile;
File created.
</code></pre>
<p>关闭数据库：</p>
<pre><code>SQL&gt; shutdown immediate
Database closed.
Database dismounted.
ORACLE instance shut down.
</code></pre>
<p>启动数据库到mount状态：</p>
<pre><code>SQL&gt; startup mount;
ORACLE instance started.
Total System Global Area 603979776 bytes
Fixed Size 1220796 bytes
Variable Size 163581764 bytes
Database Buffers 432013312 bytes
Redo Buffers 7163904 bytes
Database mounted.
</code></pre>
<h4>2)运行nid,更改<code>dbname</code>和<code>dbid</code></h4>
<p>nid即new database id，根据<code>dbname</code>生成新的<code>dbid</code>：</p>
<pre><code>[oracle@shoptest dbs]$ nid target=/ dbname=CRMTEST
DBNEWID: Release 10.2.0.1.0 - Production on Tue Oct 9 20:02:52 2012
Copyright (c) 1982, 2005, Oracle. All rights reserved.
Connected to database DBTEST (DBID=1176995883)
Connected to server version 10.2.0
Control Files in database:
/db/oracle/oradata/dbtest/control01.ctl
/db/oracle/oradata/dbtest/control02.ctl
/db/oracle/oradata/dbtest/control03.ctl
Change database ID and database name DBTEST to CRMTEST? (Y/[N]) =&gt; y
Proceeding with operation
Changing database ID from 1176995883 to 889633516
Changing database name from DBTEST to CRMTEST
Control File /db/oracle/oradata/dbtest/control01.ctl - modified
Control File /db/oracle/oradata/dbtest/control02.ctl - modified
Control File /db/oracle/oradata/dbtest/control03.ctl - modified
Datafile /db/oracle/oradata/dbtest/system01.dbf - dbid changed, wrote new name
Datafile /db/oracle/oradata/dbtest/undotbs01.dbf - dbid changed, wrote new name
Datafile /db/oracle/oradata/dbtest/sysaux01.dbf - dbid changed, wrote new name
Datafile /db/oracle/oradata/dbtest/users01.dbf - dbid changed, wrote new name
Datafile /db/oracle/oradata/dbtest/crm_data01.dbf - dbid changed, wrote new name
Datafile /db/oracle/oradata/dbtest/crm_index01.dbf - dbid changed, wrote new name
Datafile /db/oracle/oradata/dbtest/temp01.dbf - dbid changed, wrote new name
Datafile /db/oracle/oradata/dbtest/crm_temp01.dbf - dbid changed, wrote new name
Control File /db/oracle/oradata/dbtest/control01.ctl - dbid changed, wrote new name
Control File /db/oracle/oradata/dbtest/control02.ctl - dbid changed, wrote new name
Control File /db/oracle/oradata/dbtest/control03.ctl - dbid changed, wrote new name
Instance shut down
Database name changed to CRMTEST.
Modify parameter file and generate a new password file before restarting.
Database ID for database CRMTEST changed to 889633516.
All previous backups and archived redo logs for this database are unusable.
Database is not aware of previous backups and archived logs in Recovery Area.
Database has been shutdown, open database with RESETLOGS option.
Succesfully changed database name and ID.
DBNEWID - Completed succesfully.
</code></pre>
<h4>3)更改initdbtest.ora，将<code>db_name</code>设置为CRMTEST</h4>
<p>进入到$ORACLE_HOME/dbs目录：</p>
<pre><code>[oracle@shoptest dbs]$ pwd
/db/oracle/product/10.2.0/db_1/dbs
</code></pre>
<p>更改<code>db_name</code>参数，改为CRMTEST：</p>
<pre><code>[oracle@shoptest dbs]$ vim initdbtest.ora
... ...
*.db_name='CRMTEST'
... ...
</code></pre>
<h4>4)以<code>initdbtest.ora</code>启动数据库到mount状态</h4>
<pre><code>SQL&gt; startup mount pfile='/db/oracle/product/10.2.0/db_1/dbs/initdbtest.ora';
ORACLE instance started.
Total System Global Area 603979776 bytes
Fixed Size 1220796 bytes
Variable Size 163581764 bytes
Database Buffers 432013312 bytes
Redo Buffers 7163904 bytes
Database mounted.
</code></pre>
<h4>5)以resetlogs开启数据库</h4>
<pre><code>SQL&gt; alter database open resetlogs;
Database altered.
</code></pre>
<p>查看当前数据库的names：</p>
<pre><code>SQL&gt; show parameter name
NAME                       TYPE      VALUE
-------------------------- --------- --------------------
db_file_name_convert       string
db_name                    string    CRMTEST
db_unique_name             string    dbtest
global_names               boolean   FALSE
instance_name              string    dbtest
lock_name_space            string
log_file_name_convert      string
service_names              string    dbtest
</code></pre>
<p>到这里，已经将<code>dbname</code>从dbtest更改为CRMTEST，但<code>instance_name</code>还是dbtest，接下来 将<code>intance_name</code>更改为CRMTEST。 其他的如<code>db_unique_name</code>，<code>service_names</code>同样更改为CRMTEST。</p>
<h3>2. 再更改<code>instance_name</code></h3>
<p>更改数据库的<code>instance_name</code>，主要步骤如下：</p>
<ul>
<li>1)创建新的密码文件：<code>orapwd</code></li>
<li>2)创建新的初始化参数文件:<code>cp init&lt;SID&gt;.ora to init&lt;NEW_SID&gt;.ora</code>，并作修改</li>
<li>3)以新的初始化参数文件启动数据库：<code>startup pfile='?/dbs/init&lt;NEW_SID&gt;.ora</code></li>
<li>4)更改数据库以spfile启动:<code>create spfile from pfile</code></li>
<li>5)修改监听：<code>vim $ORACLE_HOME/network/admin/listener.ora</code></li>
</ul>
<h3>1)创建新的密码文件<code>orapwCRMTEST</code></h3>
<pre><code>[oracle@shoptest dbs]$ pwd
/db/oracle/product/10.2.0/db_1/dbs
[oracle@shoptest dbs]$ orapwd file=orapwCRMTEST password=oracle entries=5
[oracle@shoptest dbs]$ ll
total 7252
-rw-r----- 1 oracle oinstall 1544 Oct 9 20:20 hc_dbtest.dat
-rw-r--r-- 1 oracle oinstall 1436 Oct 9 20:04 initdbtest.ora
-r--r--r-- 1 oracle oinstall 982 May 24 15:20 initdbtest.ora.dist
-rw-r----- 1 oracle oinstall 12920 May 3 2001 initdw.ora
-rw-r----- 1 oracle oinstall 8385 Sep 11 1998 init.ora
-rw-r----- 1 oracle oinstall 24 May 24 14:43 lkDBTEST
-rw-r----- 1 oracle oinstall 2048 Oct 9 20:23 orapwCRMTEST
-rw-r----- 1 oracle oinstall 1536 Sep 21 19:31 orapwdbtest
-rw-r----- 1 oracle oinstall 7356416 Oct 9 20:06 snapcf_dbtest.f
-rw-r----- 1 oracle oinstall 3584 Oct 9 20:17 spfiledbtest.ora
</code></pre>
<h4>2)创建initCRMTEST.ora文件，设置相关参数</h4>
<p>拷贝initdbtest.ora到initCRMTEST.ora：</p>
<pre><code>[oracle@shoptest dbs]$ cp initdbtest.ora initCRMTEST.ora
</code></pre>
<p>更改initCRMTEST.ora文件，主要是instance_name，db_unique_name，dispatcher等：</p>
<pre><code>[oracle@shoptest dbs]$ vim initCRMTEST.ora 
CRMTEST.__db_cache_size=432013312
CRMTEST.__java_pool_size=4194304
CRMTEST.__large_pool_size=4194304
CRMTEST.__shared_pool_size=155189248
CRMTEST.__streams_pool_size=0
... ...
*.db_name='CRMTEST'
*.db_unique_name='CRMTEST'
*.dispatchers='(PROTOCOL=TCP) (SERVICE=CRMTESTXDB)'
... ...
</code></pre>
<h4>3)以initCRMTEST.ora启动数据库</h4>
<p>因实例名已经从dbtest改为CRMTEST，需重新设置<code>ORACLE_SID</code>：</p>
<pre><code>[oracle@shoptest dbs]$ export ORACLE_SID=CRMTEST
</code></pre>
<p>以initCRMTEST.ora重启数据库：</p>
<pre><code>SQL&gt; conn /as sysdba
Connected.
SQL&gt; shutdown immediate;
Database closed.
Database dismounted.
ORACLE instance shut down.
SQL&gt; startup pfile='/db/oracle/product/10.2.0/db_1/dbs/initCRMTEST.ora';
ORACLE instance started.
Total System Global Area 603979776 bytes
Fixed Size 1220796 bytes
Variable Size 163581764 bytes
Database Buffers 432013312 bytes
Redo Buffers 7163904 bytes
Database mounted.
Database opened.
</code></pre>
<p>查看当前数据库的names</p>
<pre><code>SQL&gt; show parameter name
NAME                        TYPE      VALUE
--------------------------- --------- ------------------
db_file_name_convert        string
db_name                     string    CRMTEST
db_unique_name              string    CRMTEST
global_names                boolean   FALSE
instance_name               string    CRMTEST
lock_name_space             string
log_file_name_convert       string
service_names               string    dbtest
</code></pre>
<h4>4)创建spfile，并以spfile重启数据库</h4>
<p>从pfile创建spfile：</p>
<pre><code>SQL&gt; create spfile from pfile;
File created.
</code></pre>
<p>关闭数据库：</p>
<pre><code>SQL&gt; shutdown immediate;
Database closed.
Database dismounted.
ORACLE instance shut down.
</code></pre>
<p>启动数据库：</p>
<pre><code>SQL&gt; startup;
ORACLE instance started.
Total System Global Area 603979776 bytes
Fixed Size 1220796 bytes
Variable Size 163581764 bytes
Database Buffers 432013312 bytes
Redo Buffers 7163904 bytes
Database mounted.
Database opened.
</code></pre>
<p>确认当前数据库使用的参数文件类型：</p>
<pre><code>SQL&gt; show parameter spfile;
NAME                       TYPE     VALUE
-------------------------- -------- ------------------------------
spfile                     string   /db/oracle/product/10.2.0/db_1/
                                    dbs/spfileCRMTEST.ora
</code></pre>
<p>更改service_names：</p>
<pre><code>SQL&gt; alter system set service_names=CRMTEST;

System altered.
</code></pre>
<p>再次查看当前数据库的names：</p>
<pre><code>SQL&gt; show parameter name
NAME                        TYPE      VALUE
--------------------------- --------- ------------------
db_file_name_convert        string
db_name                     string    CRMTEST
db_unique_name              string    CRMTEST
global_names                boolean   FALSE
instance_name               string    CRMTEST
lock_name_space             string
log_file_name_convert       string
service_names               string    CRMTEST
</code></pre>
<p>查看当前数据库的归档模式：</p>
<pre><code>SQL&gt; archive log list;
Database log mode Archive Mode
Automatic archival Enabled
Archive destination USE_DB_RECOVERY_FILE_DEST
Oldest online log sequence 1
Next log sequence to archive 1
Current log sequence 1
</code></pre>
<h4>5)修改并重启监听</h4>
<p>修改监听中的<code>SID_NAME</code>和<code>GLOBAL_DBNAME</code>：</p>
<pre><code>[oracle@shoptest admin]$ vim listener.ora
# listener.ora Network Configuration File: /db/oracle/product/10.2.0/db_1/network/admin/listener.ora
# Generated by Oracle configuration tools.

SID_LIST_LISTENER =
    (SID_LIST =
        (SID_DESC =
            (SID_NAME = PLSExtProc)
            (ORACLE_HOME = /db/oracle/product/10.2.0/db_1)
            (PROGRAM = extproc)
        )
        (SID_DESC =
            (GLOBAL_DBNAME= CRMTEST)
            (ORACLE_HOME = /db/oracle/product/10.2.0/db_1)
            (SID_NAME = CRMTEST)
        )
    )

LISTENER =
    (DESCRIPTION_LIST =
        (DESCRIPTION =
            (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1))
            (ADDRESS = (PROTOCOL = TCP)(HOST = shoptest.egolife.com)(PORT = 1521))
        )
)
</code></pre>
<p>重启监听：</p>
<pre><code>[oracle@shoptest admin]$ lsnrctl start
LSNRCTL for Linux: Version 10.2.0.1.0 - Production on 10-OCT-2012 19:52:12
Copyright (c) 1991, 2005, Oracle. All rights reserved.
Starting /db/oracle/product/10.2.0/db_1/bin/tnslsnr: please wait...

TNSLSNR for Linux: Version 10.2.0.1.0 - Production
System parameter file is /db/oracle/product/10.2.0/db_1/network/admin/listener.ora
Log messages written to /db/oracle/product/10.2.0/db_1/network/log/listener.log
Listening on: (DESCRIPTION=(ADDRESS=(PROTOCOL=ipc)(KEY=EXTPROC1)))
Listening on: (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=shoptest.egolife.com)(PORT=1521)))

Connecting to (DESCRIPTION=(ADDRESS=(PROTOCOL=IPC)(KEY=EXTPROC1)))
STATUS of the LISTENER
------------------------
Alias LISTENER
Version TNSLSNR for Linux: Version 10.2.0.1.0 - Production
Start Date 10-OCT-2012 19:52:13
Uptime 0 days 0 hr. 0 min. 0 sec
Trace Level off
Security ON: Local OS Authentication
SNMP OFF
Listener Parameter File /db/oracle/product/10.2.0/db_1/network/admin/listener.ora
Listener Log File /db/oracle/product/10.2.0/db_1/network/log/listener.log
Listening Endpoints Summary...
(DESCRIPTION=(ADDRESS=(PROTOCOL=ipc)(KEY=EXTPROC1)))
(DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=shoptest.egolife.com)(PORT=1521)))
Services Summary...
Service "CRMTEST" has 1 instance(s).
Instance "CRMTEST", status UNKNOWN, has 1 handler(s) for this service...
Service "PLSExtProc" has 1 instance(s).
Instance "PLSExtProc", status UNKNOWN, has 1 handler(s) for this service...
The command completed successfully
</code></pre>
<p>最后，注意更改bash环境变量，设置<code>ORACLE_SID=CRMTEST</code>，之前使用
<code>export ORACLE_SID=CRMTEST</code>仅对当前的用户有效</p>
<pre><code>[oracle@shoptest admin]$ vim ~/.bash_profile
... ...
export ORACLE_SID=CRMTEST
... ...
</code></pre>
<h2>测试和确认</h2>
<p>这样数据库的<code>instance_name</code>就更改完成，下面进行一些简单的测试，确认更改成功，主
要测试一下几个方面：
<em> 监听正常，可以接收连接请求：tnsping crmtest
</em> 密码文件生效：conn sys@crmtest /as sysdba</p>
<h3>1. 监听测试</h3>
<h4>服务器端连接测试</h4>
<p>配置tnsnames.ora：</p>
<pre><code>[oracle@shoptest admin]$ vim tnsnames.ora
CRMTEST =
    (DESCRIPTION =
        (ADDRESS = (PROTOCOL = TCP)(HOST = shoptest.egolife.com)(PORT = 1521))
        (CONNECT_DATA =
            (SERVER = DEDICATED)
            (SERVICE_NAME = CRMTEST)
        )
    )

EXTPROC_CONNECTION_DATA =
    (DESCRIPTION =
        (ADDRESS_LIST =
            (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1))
        )
        (CONNECT_DATA =
            (SID = PLSExtProc)
           (PRESENTATION = RO)
        )
    )
</code></pre>
<p>使用tnsping，测试crmtest连接是否正常：</p>
<pre><code>[oracle@shoptest admin]$ tnsping crmtest
TNS Ping Utility for Linux: Version 10.2.0.1.0 - Production on 10-OCT-2012 19:54:31
Copyright (c) 1997, 2005, Oracle. All rights reserved.

Used parameter files:
/db/oracle/product/10.2.0/db_1/network/admin/sqlnet.ora

Used TNSNAMES adapter to resolve the alias
Attempting to contact (DESCRIPTION = (ADDRESS = (PROTOCOL = TCP)(HOST = shoptest.egolife.com)(PORT = 1521)) (CONNECT_DATA = (SERVER = DEDICATED) (SERVICE_NAME = CRMTEST)))
OK (0 msec)
</code></pre>
<h4>Windows客户端连接测试</h4>
<p>同样，先配置tnsnames.ora，然后运行tnsping crmtest，确认是否可以连接：</p>
<pre><code>C:\&gt; tnsping crmtest
TNS Ping Utility for 32-bit Windows: Version 11.2.0.1.0 - Production on 10-10月-2012 20:09:57
Copyright (c) 1997, 2010, Oracle. All rights reserved.

已使用的参数文件:
D:\Oracle\11g\product\11.2.0\db_1\network\admin\sqlnet.ora

已使用 TNSNAMES 适配器来解析别名
尝试连接 (DESCRIPTION = (ADDRESS = (PROTOCOL = TCP)(HOST = shoptest.egolife.com)(PORT = 1521)) (CONNECT_DATA = (SERVER = DEDICATED) (SERVICE_NAME = CRMTEST)))
OK (0 毫秒)
</code></pre>
<h3>2. orapwCRMTEST密码文件生效测试</h3>
<p>再使用sqlplus以sysdba身份登录，检查密码文件是否生效：</p>
<pre><code>C:\&gt;sqlplus /nolog
SQL*Plus: Release 11.2.0.1.0 Production on 星期三 10月 10 20:11:38 2012
Copyright (c) 1982, 2010, Oracle. All rights reserved.
SQL&gt; conn sys@crmtest/as sysdba
输入口令:
已连接。
SQL&gt;
</code></pre>
<h2>参考</h2>
<ul>
<li><a href="http://blog.csdn.net/tianlesoftware/article/details/6087641">Oracle 修改DB_NAME 和 DBID</a></li>
<li><a href="http://oonicedream.itpub.net/post/36905/457005">如何修改数据库实例名</a></li>
</ul> 
                </div>
        </div>
</div>

                                </div>
                        </div>
                </div>
        </div>
        <div id="footer">

        <div class="modal-footer">
                <p class="text-center">
                        Blog of <a href="/">dylan</a>.
                        Follow me on <a href="https://twitter.com/dylanninin" target="_blank">twitter</a>
                        or <a href="http://weibo.com/dylanninin" target="_blank">weibo</a>
                </p>
                <p class="text-center">
                        UI Designed by <a href="http://twitter.github.com/bootstrap" target="_blank">Twitter
                                Bootstrap</a>.
                        Powered by <a href="http://webpy.org" target="_blank">Web.py</a>.
                        Hosted by <a href="http://www.linode.com" target="_blank">Linode</a>.
                        Licensed under <a
                                href="http://creativecommons.org/licenses/by-nc-nd/3.0/" target="_blank">CC BY
                                3.0</a>
                </p>
                <p class="text-center">
                        Copyright &copy <a href="/">CLOUD</a> |
                        <a href="/about.html">About</a>
                </p>

        </div>
        <script src="/static/js/jquery.js"></script>
        <script src="/static/js/jquery-3.1.1.min.js"></script>
    <script src="/static/js/bootstrap.js"></script>
</div>

</body>
</html>

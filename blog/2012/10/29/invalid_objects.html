<!DOCTYPE html>
<html lang='zh'>
        <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="stylesheet" href="//cdn.static.runoob.com/libs/bootstrap/3.3.7/css/bootstrap.min.css">
    <title>invalid objects</title>
</head>

<body>
        <div id="header">
    <nav class="navbar navbar-default" role="navigation">
                <div class="container-fluid">
                        <div class="navbar-header">
                                <a class="navbar-brand" href="/">CLOUD</a>
                        </div>
                        <div class="collapse navbar-collapse" id="example-navbar-collapse">
                                <ul class="nav navbar-nav">
                                        <li><a href="/tweet"><i class="icon-retweet icon-white"></i>Tweets</a></li>
                                        <li><a href="/archive.html"><i class="icon-book icon-white"></i>Archives</a></li>
                                        <li><a href="/category.html"><i class="icon-th-list icon-white"></i>category</a></li>
                                        <li><a href="/about.html"><i class="icon-user icon-white"></i>About</a></li>
                                        <li class="dropdown">
                                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                                        Friend Links <b class="caret"></b>
                                                </a>
                                                <ul class="dropdown-menu">
                                                        <li><a href="http://www.ruanyifeng.com/home.html" target="_blank">阮一峰</a></li>
                                                        <li><a href="http://coolshell.cn/" target="_blank">陈皓haoel</a></li>
                                                        <li><a href="http://www.dbanotes.net/" target="_blank">冯大辉Fenng</a></li>
                                                        <li><a href="http://robbin.iteye.com/" target="_blank">范凯robbin</a></li>
                                                        <li><a href="http://www.eygle.com/" target="_blank">盖国强eygle</a></li>
                                                        <li><a href="http://blog.csdn.net/tianlesoftware" target="_blank">David Dai</a></li>
                                                        <li><a href="http://www.joelonsoftware.com/" target="_blank">Joel Spolsky</a></li>
                                                        <li><a href="http://mindhacks.cn/" target="_blank">刘未鹏MindHacks</a></li>
                                                        <li><a href="http://www.my1510.cn/author.php?roseluqiu" target="_blank">闾丘露薇</a></li>
                                                        <li><a href="http://www.dapenti.com/blog/" target="_blank">铂程斋dapenti</a></li>
                                                </ul>
                                        </li>
                                </ul>
                        </div>
                </div>
        </nav>
</div>


        <div id="content">
                <div class="container">
                        <div class="row">
                                <div>
                                        <div class="entry">
        <div class="entry entry-detail">
                    <div class="entry-header">
                            <h1 class="entry-title">invalid objects</h1>
                            <div class="entry-meta">
                                    <span class="entry-by">
                                            <i class="icon-user"></i> <a href="/">dylan</a> on 2012-10-29 14:35:57
                                    </span>
                            </div>
                    </div>
                <div class="entry-content">
                        <h2>异常症状</h2>
<p>在Oracle EBS系统中可以正常打开物料编辑页面，输入料号、描述等，选择物料模板，点击 保存按钮保存；此时切换到组织属性或组织分配页，再切换回物料属性页或者按料号查找该 物料，均无法找到该物料的信息；直接在数据库中查找该物料为空。</p>
<h2>异常确认</h2>
<p>登录到Oracle ERP系统，输入物料确实无法保存；最大化编辑页面，Oracle Forms左下角没 有保存数据的事务操作提示。</p>
<h2>环境</h2>
<ul>
<li>Oracle RDBMS : 11.1.0.7.0</li>
<li>Oracle Applications : 12.1.1</li>
</ul>
<h2>异常解决</h2>
<p>在ERP服务器上部署了一些定时任务，其中每天结束前（23:55）会定时检查数据库系统的警 告日志，若有错误，则会发送邮件通知。</p>
<p>2012-10-29 收到来自此ERP系统的警告日志邮件通知。</p>
<h3>警告日志</h3>
<p>alert_PROD.log.2012-10-28</p>
<pre><code>Fri Oct 26 14:24:24 2012
Errors in file /u1/PROD/prodora/db/tech_st/11.1.0/admin/PROD_poprod/diag/rdbms/prod/
PROD/trace/PROD_ora_14573.trc  (incident=22169):
ORA-00600: internal error code, arguments: [qcsgpvc3], [], [], [], [], [], [], [], [], [], [], []
Incident details in: /u1/PROD/prodora/db/tech_st/11.1.0/admin/PROD_poprod/diag/rdbms/
prod/PROD/incident/incdir_22169/PROD_ora_14573_i22169.trc
Non critical error ORA-48913 caught while writing to trace file "/u1/PROD/prodora/db/tech_st/11.1.0/admin/PROD_poprod/diag/rdbms/
prod/PROD/incident/incdir_22169/PROD_ora_14573_i22169.trc"
Error message: ORA-48913: Writing into trace file failed, file size limit [10485760] reached
Writing to the above trace file is disabled for now on...
</code></pre>
<h3>跟踪日志</h3>
<p><code>PROD_ora_14573_i22169.trc</code></p>
<pre><code>... ...
*** 2012-10-26 14:24:24.811
*** SESSION ID:(307.48840) 2012-10-26 14:24:24.811
*** CLIENT ID:() 2012-10-26 14:24:24.811
*** SERVICE NAME:(PROD) 2012-10-26 14:24:24.811
*** MODULE NAME:(PL/SQL Developer) 2012-10-26 14:24:24.811
*** ACTION NAME:(Main session) 2012-10-26 14:24:24.811

Dump continued from file: /u1/PROD/prodora/db/tech_st/11.1.0/admin/PROD_poprod/diag/rdbms/PROD_ora_14573.trc
</code></pre>
<p><code>PROD_ora_14573.trc</code></p>
<pre><code>ORA-00600: internal error code, arguments: [qcsgpvc3], [], [], [], [], [], [], [], [], [], [], []
========= Dump for incident 22169 (ORA 600 [qcsgpvc3]) ========
----- Beginning of Customized Incident Dump(s) -----
QCSGPVC3: icodefs yet to be processed = 1
QCSGPVC3: ico = 0x7fa94803cad0
QCSGPVC3: ico-&gt;icocop = 0x7fa9478e3ab8
QCSGPVC3: ico-&gt;icocop-&gt;colkcc = (nil)
QCDDMP: -------------------------------------------------------
QCDDMP:  qcsgpvc3_CTX: [0x7fa94801ee10]
QCDDMP:  {
QCDDMP:    -&gt;ctxqbc: [0x7fa94801d068]
QCDDMP:    {
QCDDMP:      -&gt;qbcqtxt: N/A
QCDDMP:      -&gt;qbcfro: [0x7fa94801d3f0]
QCDDMP:      {
QCDDMP:        -&gt;frooid: [(nil)]
QCDDMP:        -&gt;frotni: MTL_SYSTEM_ITEMS_INTERFACE
QCDDMP:        -&gt;froaid: MTL_SYSTEM_ITEMS_INTERFACE
QCDDMP:        -&gt;frotyp = 2
QCDDMP:        -&gt;froflg = 0x4b
... ...
</code></pre>
<p>其中MTL_SYSTEM_ITEMS_INTERFACE表为物料接口表，用于临时保存物料信息。无法保存物 料，可能和此表异常相关。</p>
<p>在MOS上找到关于ORA-600[qcsgpvc3]的一篇文档，有可能是存储过程依赖的表结构发生了变 更，重新编译存储过程时会出现此错误。</p>
<p>根据此文档，在R12的测试环境上进行测试，过程如下：</p>
<pre><code>SQL&gt; create table xx_qcsgpvc( c1 varchar2(60),c2 number);
Table created.
SQL&gt; create or replace package xx_qcsgpvc_p is
  2  procedure po(c1 varchar2, c2 number);
  3  end xx_qcsgpvc_p;
  4  /
Package created.

SQL&gt; create or replace package body xx_qcsgpvc_p is
  2  procedure po(c1 varchar2,c2 number)
  3  is
  4  begin
  5  insert into xx_qcsgpvc(c1,c2) values (c1,c2);
  6  end po;
  7  end xx_qcsgpvc_p;
  8  /
Package body created.

SQL&gt; alter table xx_qcsgpvc rename column c2 to i_problem;
Table altered.

SQL&gt; alter package xx_qcsgpvc_p compile body;
Warning: Package Body altered with compilation errors.
</code></pre>
<h3>警告日志</h3>
<p>alert_VIS.ora</p>
<pre><code>Mon Oct 29 09:15:01 2012
Errors in file
/u1/VIS/visora/db/tech_st/11.1.0/admin/VIS_demoerp/diag/rdbms/
vis/VIS/trace/VIS_ora_925.trc  (incident=24961):
ORA-00600: internal error code, arguments: [qcsgpvc3], [], [], [], [], [], [], [], [], [], [], []
Incident details in:
/u1/VIS/visora/db/tech_st/11.1.0/admin/VIS_demoerp/diag/rdbms/vis/
VIS/incident/incdir_24961/VIS_ora_925_i24961.trc
</code></pre>
<h3>跟踪日志</h3>
<p><code>VIS_ora_925_i24961.trc</code></p>
<pre><code>... ...
*** 2012-10-29 09:15:01.536
*** SESSION ID:(278.26930) 2012-10-29 09:15:01.536
*** CLIENT ID:() 2012-10-29 09:15:01.536
*** SERVICE NAME:(SYS$USERS) 2012-10-29 09:15:01.536
*** MODULE NAME:(SQL*Plus) 2012-10-29 09:15:01.536
*** ACTION NAME:() 2012-10-29 09:15:01.536

Dump continued from file:
/u1/VIS/visora/db/tech_st/11.1.0/admin/VIS_demoerp/diag/rdbms/
vis/VIS/trace/VIS_ora_925.trc
ORA-00600: internal error code, arguments: [qcsgpvc3], [], [], [], [], [], [], [], [], [], [], []
========= Dump for incident 24961 (ORA 600 [qcsgpvc3]) ========
----- Beginning of Customized Incident Dump(s) -----
QCSGPVC3: icodefs yet to be processed = 1
QCSGPVC3: ico = 0x7fc230514c90
QCSGPVC3: ico-&gt;icocop = 0x7fc2305152b8
QCSGPVC3: ico-&gt;icocop-&gt;colkcc = (nil)
QCDDMP: -------------------------------------------------------
QCDDMP:  qcsgpvc3_CTX: [0x7fc2305106b8]
QCDDMP:  {
QCDDMP:    -&gt;ctxqbc: [0x7fc230514438]
QCDDMP:    {
QCDDMP:      -&gt;qbcqtxt: N/A
QCDDMP:      -&gt;qbcfro: [0x7fc2305147c0]
QCDDMP:      {
QCDDMP:        -&gt;frooid: [(nil)]
QCDDMP:        -&gt;frotni: XX_QCSGPVC
QCDDMP:        -&gt;froaid: XX_QCSGPVC
QCDDMP:        -&gt;frotyp = 2
QCDDMP:        -&gt;froflg = 0x43
... ...
</code></pre>
<p>根据以上日志，可能是系统对象做过更改，导致依赖于这些对象的存储过程失效而无法正常 运行。</p>
<p>查看物料相关表创建编译时间</p>
<pre><code>SELECT owner,
       object_name,
       object_type,
       created,
       last_ddl_time,
       TIMESTAMP,
       status
  FROM dba_objects do
  WHERE do.object_name IN ('MTL_SYSTEM_ITEMS_INTERFACE', 'MTL_SYSTEM_ITEMS_B');
</code></pre>
<p>物料表和物料接口表近期均未更改和重编译。</p>
<h3>紧接着查找系统无效对象</h3>
<p>无效对象</p>
<pre><code>SELECT owner,
       object_name,
       object_type,
       status
  FROM dba_objects
 WHERE status = 'INVALID'
 ORDER BY owner,
          object_type,
          object_name;
output:
APPS        OE_ITEMS_MV         MATERIALIZED VIEW       INVALID
APPS        XX_IMPORT_MATERIEL_PCK   PACKAGE BODY        INVALID
APPS        XX_ITEM_DEFAULT_SUBINVENTORY      TRIGGER INVALID
</code></pre>
<p>无效对象和依赖关系</p>
<pre><code>SELECT object_name,
       object_type,
       referenced_owner,
       referenced_type,
       referenced_name
  FROM user_objects,
       user_dependencies
 WHERE object_name = NAME
   AND status != 'VALID'
 ORDER BY object_name,
          object_type,
          referenced_owner,
          referenced_type,
          referenced_name;
</code></pre>
<p>生成无效对象的编译脚本</p>
<pre><code>SELECT decode(object_type,
              'PACKAGE BODY',
              'alter package ' || owner || '.' || object_name ||
              ' compile body;',
              'alter ' || object_type || ' ' || owner || '.' || object_name ||
              ' compile;')
  FROM dba_objects
 WHERE status = 'INVALID'
   AND object_type IN ('PACKAGE BODY',
                       'PACKAGE',
                       'FUNCTION',
                       'PROCEDURE',
                       'TRIGGER',
                       'VIEW')
 ORDER BY object_type,
          object_name;
</code></pre>
<p>编译后，还有无效触发器<code>APPS.XX_ITEM_DEFAULT_SUBINVENTORY</code>。</p>
<p>再次尝试新建物料时，依然无法保存。</p>
<p>通过与客制化开发人员沟通，了解到最近在尝试开发物料导入功能，以减轻物料录入的负 担。此触发器在11i中使用过，但在R12中不再使用，这里暂且drop掉该触发器或者禁用该触 发器：</p>
<pre><code>DROP TRIGGER apps.XX_ITEM_DEFAULT_SUBINVENTORY;
</code></pre>
<p>再次尝试新建物料时，可以正常保存。</p>
<p>根据ORA-600[qcsgpvc3]的错误提示以及近期有客制化功能开发可以总结，因对象结构发生 变更使得系统中存在一些无效对象从而导致物料无法保存。在本例中，引起物料无法保存的 应是依赖于物料基础表MTL_SYSTEMS_ITEM_B的触发器XX_ITEM_DEFAULT_SUBINVENTORY无效， 即当对物料基础表进行插入操作时该触发器无法运行，导致整个操作失败。在客制化开发过 程中，涉及到更改标准功能或者系统标准对象等，因Oracle系统的庞大和复杂性，无法确定 做出更改后所有功能都可以正常使用；但对数据库系统的日常维护来说，定期检查和编译无 效对象是必须的，否则某些功能将不能正常运行。</p>
<h2>脚本</h2>
<p>检查数据库系统警告日志，结合crontab，若有ora error message，则发送邮件通知</p>
<p>checkalert.sh </p>
<pre><code>#!/bin/sh
#abstract:
#oracle database daily alert check and send mail notifications if ora error messages occur
#history:
#2012-08-14     dylanninin@gmail.com         first release
#variables
script_basepath=/u1/PROD/prodora/itsection/adm/sql
mail_date=$(date +%Y-%m-%d\ %H:%M:%S)
receipt=dylanninin@gmail.com
hostname=$(hostname)

#path
ORACLE_HOME=/u1/PROD/prodora/db/tech_st/11.1.0
export ORACLE_HOME
PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin:
$ORACLE_HOME/bin
export PATH
ORACLE_SID=PROD
export ORACLE_SID

#sql log file
script_name=alert
sqllog="${script_basepath}/${script_name}.log"

#check alert log
if [ "${script_name}" == "alert" ]; then
   alert_basepath=/u1/PROD/prodora/db/tech_st/11.1.0/admin/PROD_poprod/diag/rdbms/prod/PROD/trace
   alert_log=${alert_basepath}/alert_$ORACLE_SID.log
   if [ -f ${alert_log} ]; then
        current_date=$(date +%F)
        current_log=${alert_log}.${current_date}
        mv  ${alert_log} ${current_log}
        touch ${alert_log}
        grep -i ORA- ${current_log} &gt; ${sqllog}
   else
        echo -e "Oracle Instance alert log file ${alert_log} does not exist!"
        touch ${alert_log}
   fi
fi

#mail
if [ ! -e ${sqllog} ]; then
   echo -e "sqllog file ${sqllog} does not exist!"
   exit 0
fi
if [ `cat ${sqllog} | wc -l` -gt 0 ]; then
   cat ${sqllog} | mail -s "${mail_date}:${hostname} dba daily check of ${script_name}" ${receipt}
fi
</code></pre>
<h2>参考</h2>
<ul>
<li>Bug 7172752 - OERI[qcsgpvc3] recompiling a package body [ID 7172752.8]</li>
<li>Invalid Objects In Oracle Applications FAQ [ID 104457.1]</li>
</ul> 
                </div>
        </div>
</div>

                                </div>
                        </div>
                </div>
        </div>
        <div id="footer">

        <div class="modal-footer">
                <p class="text-center">
                        Blog of <a href="/">dylan</a>.
                        Follow me on <a href="https://twitter.com/dylanninin" target="_blank">twitter</a>
                        or <a href="http://weibo.com/dylanninin" target="_blank">weibo</a>
                </p>
                <p class="text-center">
                        UI Designed by <a href="http://twitter.github.com/bootstrap" target="_blank">Twitter
                                Bootstrap</a>.
                        Powered by <a href="http://webpy.org" target="_blank">Web.py</a>.
                        Hosted by <a href="http://www.linode.com" target="_blank">Linode</a>.
                        Licensed under <a
                                href="http://creativecommons.org/licenses/by-nc-nd/3.0/" target="_blank">CC BY
                                3.0</a>
                </p>
                <p class="text-center">
                        Copyright &copy <a href="/">CLOUD</a> |
                        <a href="/about.html">About</a>
                </p>

        </div>
        <script src="/static/js/jquery.js"></script>
        <script src="/static/js/jquery-3.1.1.min.js"></script>
    <script src="/static/js/bootstrap.js"></script>
</div>

</body>
</html>

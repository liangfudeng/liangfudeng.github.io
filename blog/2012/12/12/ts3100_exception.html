<!DOCTYPE html>
<html lang='zh'>
        <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="stylesheet" href="//cdn.static.runoob.com/libs/bootstrap/3.3.7/css/bootstrap.min.css">
    <title>ts3100 exception</title>
</head>

<body>
        <div id="header">
    <nav class="navbar navbar-default" role="navigation">
                <div class="container-fluid">
                        <div class="navbar-header">
                                <a class="navbar-brand" href="/">CLOUD</a>
                        </div>
                        <div class="collapse navbar-collapse" id="example-navbar-collapse">
                                <ul class="nav navbar-nav">
                                        <li><a href="/tweet"><i class="icon-retweet icon-white"></i>Tweets</a></li>
                                        <li><a href="/archive.html"><i class="icon-book icon-white"></i>Archives</a></li>
                                        <li><a href="/category.html"><i class="icon-th-list icon-white"></i>category</a></li>
                                        <li><a href="/about.html"><i class="icon-user icon-white"></i>About</a></li>
                                        <li class="dropdown">
                                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                                        Friend Links <b class="caret"></b>
                                                </a>
                                                <ul class="dropdown-menu">
                                                        <li><a href="http://www.ruanyifeng.com/home.html" target="_blank">阮一峰</a></li>
                                                        <li><a href="http://coolshell.cn/" target="_blank">陈皓haoel</a></li>
                                                        <li><a href="http://www.dbanotes.net/" target="_blank">冯大辉Fenng</a></li>
                                                        <li><a href="http://robbin.iteye.com/" target="_blank">范凯robbin</a></li>
                                                        <li><a href="http://www.eygle.com/" target="_blank">盖国强eygle</a></li>
                                                        <li><a href="http://blog.csdn.net/tianlesoftware" target="_blank">David Dai</a></li>
                                                        <li><a href="http://www.joelonsoftware.com/" target="_blank">Joel Spolsky</a></li>
                                                        <li><a href="http://mindhacks.cn/" target="_blank">刘未鹏MindHacks</a></li>
                                                        <li><a href="http://www.my1510.cn/author.php?roseluqiu" target="_blank">闾丘露薇</a></li>
                                                        <li><a href="http://www.dapenti.com/blog/" target="_blank">铂程斋dapenti</a></li>
                                                </ul>
                                        </li>
                                </ul>
                        </div>
                </div>
        </nav>
</div>


        <div id="content">
                <div class="container">
                        <div class="row">
                                <div>
                                        <div class="entry">
        <div class="entry entry-detail">
                    <div class="entry-header">
                            <h1 class="entry-title">ts3100 exception</h1>
                            <div class="entry-meta">
                                    <span class="entry-by">
                                            <i class="icon-user"></i> <a href="/">dylan</a> on 2012-12-12 14:35:57
                                    </span>
                            </div>
                    </div>
                <div class="entry-content">
                        <h2>环境</h2>
<ul>
<li>OS：IBM Power System 550 AIX 5.3 (64 bit)</li>
<li>Storage：TS 3100/Tivoli Storage Manager Server 5.4.3.0</li>
<li>Application：Oracle EBS 11.5.10.2 (64 bit)/Oracle RDBMS 9.2.0.6 (64 bit)</li>
<li>Backup：RMAN (Database/Archivelog)</li>
</ul>
<h2>简介</h2>
<p>IBM Tivoli Storage Manager（TSM）是为解决企业级数据及系统安全而设计的备份全面解 决方案。Tivoli ITSM 系统已成为当今数据备份领域的首选产品，并为包括金融、电信在内 的许多大型用户和广大的中小型企业用户，解决困扰信息技术部门的备份管理问题。 </p>
<p>为了满足企业所面临的上述问题，我们建议使用一台服务器作为 TSM 备份服务器，使用带 库作为备份介质，将整个企业 IT 环境内的备份操作交由 TSM 备份服务器完成，由 TSM 备 份服务器集中完成所有备份任务的调度、管理以及备份介质的集中管理。</p>
<p>为了解决企业所面临的数据备份问题，备份解决方案需要能够提供：</p>
<ul>
<li>全自动的备份，所有的操作系统，应用，数据库的备份都可以通过设定计划自动运行；</li>
<li>集中的备份管理，集中进行整个备份系统的备份策略设置，存储池配置等工作，便于备份系统的管理和维护；</li>
<li>全面的数据备份支持，支持大量异构的系统（操作系统，数据库以及各种应用系统）和各种硬件存储设备，能够充分兼容企业内部几乎所有的软硬件平台;</li>
<li>友好的用户界面，方便使用和管理操作，提供 GUI，Web-based，以及 CLI 管理和操作平台；</li>
<li>支持 LAN、SAN、NAS 等多种存储环境；</li>
<li>其他众多先进的技术特性，如完善的介质管理技术、内置关系数据库、备份数据加密及压缩技术等。</li>
</ul>
<h2>备份检查</h2>
<p>以网页方式查看</p>
<p>检查备份路径：Server Administartion &gt;&gt; Object View &gt;&gt; Policy Domains &gt;&gt; Client schedules &gt;&gt; Query Client Events</p>
<p>输入查询条件，查询备份状态如下</p>
<pre><code>Operation Results
Scheduled Start      Actual Start         Schedule Name   Node Name     Status   
-------------------- -------------------- --------------- ------------- ---------
12/11/12 07:00:00    12/11/12 07:11:09    DELETEEXPIRED   ORAPROD       Completed
12/11/12 08:00:00    12/11/12 08:08:21    DELEXP_ORATEST  ORATEST       Completed                                
12/11/12 20:00:00    12/11/12 20:00:08    ARCBAK          ORAPROD       Completed
12/11/12 21:00:00    12/11/12 21:06:39    ARC_ORATEST     ORATEST       Completed
12/11/12 23:00:00    12/11/12 23:01:55    FULLBAKUPORACLE ORAPROD       Failed  1                    
12/12/12 07:00:00    12/12/12 07:04:07    DELETEEXPIRED   ORAPROD       Completed
12/12/12 08:00:00    12/12/12 08:10:42    DELEXP_ORATEST  ORATEST       Completed
</code></pre>
<h2>异常信息</h2>
<p>检查异常事件路径：Server Administartion &gt;&gt; Object View &gt;&gt; Server &gt;&gt; Activity Log</p>
<p>根据备份失败时间，输入条件；本例中备份出错为生产环境数据库全备阶段，时间为12/11/12 23:01:55左右。查询该时间段日志，错误信息如下：</p>
<pre><code>12/11/12 23:09:57     ANR1405W Scratch volume mount request denied - no scratch 
                      volume available. (SESSION: 8460)                        
12/11/12 23:09:57     ANR0522W Transaction failed for session 8460 for node     
                      ORAPROD (TDP Oracle AIX) - no space available in storage 
                      pool ORADBPOOL and all successor pools. (SESSION: 8460)  
12/11/12 23:09:57     ANR0403I Session 8460 ended for node ORAPROD (TDP Oracle  
                      AIX). (SESSION: 8460)                                    
12/11/12 23:10:05     ANR0406I Session 8461 started for node ORAPROD (TDP Oracle
                      AIX) (Tcp/Ip 10.20.1.8(41271)). (SESSION: 8461)          
12/11/12 23:10:05     ANE4994S (Session: 8461, Node: ORAPROD)  TDP Oracle AIX   
                      ANU0599 TDP for Oracle: (6475950): =&gt;(oraprod) ANU2602E  
                      The object /adsmorc//XSDB_PROD_801788468_dcnskkhk_1_1 was
                      not found on the TSM Server (SESSION: 8461)              
12/11/12 23:10:05     ANR0403I Session 8461 ended for node ORAPROD (TDP Oracle  
                      AIX). (SESSION: 8461)                                    
12/11/12 23:10:06     ANR2579E Schedule FULLBAKUPORACLE in domain STANDARD for  
                      node ORAPROD failed (return code 1). (SESSION: 8447)     
12/11/12 23:10:06     ANR0403I Session 8447 ended for node ORAPROD (AIX).       
                      (SESSION: 8447)                                          
12/11/12 23:10:06     ANR0406I Session 8462 started for node ORAPROD (AIX)      
                      (Tcp/Ip x.x.x.x(41274)). (SESSION: 8462)               
12/11/12 23:10:06     ANR0403I Session 8462 ended for node ORAPROD (AIX).       
                      (SESSION: 8462)
</code></pre>
<p>主要错误： no space available in storage pool ORADBPOOL and all successor pools，即带库中没有临时卷(空闲磁带)用于备份。</p>
<h2>异常处理</h2>
<p>此时可进行登陆到带库管理服务器上，进行以下操作，确认备份异常，并进行相应处理。</p>
<h3>登陆服务器</h3>
<p>以应用账户ssh登陆到服务器，并运行dsmadmc命令，进入带库管理环境。</p>
<pre><code>$ set -o vi
$ dsmadmc
IBM Tivoli Storage Manager
Command Line Administrative Interface - Version 5, Release 4, Level 0.0
(c) Copyright by IBM Corporation and other(s) 1990, 2007. All Rights Reserved.

Enter your user id:  admin
Enter your password:

Session established with server TSM: AIX-RS/6000
Server Version 5, Release 4, Level 3.0
Server date/time: 12/12/12   11:33:35  Last access: 12/12/12   11:23:06
</code></pre>
<h3>查看日志</h3>
<p>q act begindate 可查看系统日志，同web页面相应功能。</p>
<pre><code>tsm: TSM&gt;q act begindate=-1

Date/Time                Message                                                   
--------------------     ----------------------------------------------------------
...
12/11/12   23:09:56      ANR1405W Scratch volume mount request denied - no scratch 
                         volume available. (SESSION: 8460)                        
12/11/12   23:09:56      ANR1405W Scratch volume mount request denied - no scratch 
                         volume available. (SESSION: 8460)                        
12/11/12   23:09:57      ANR1405W Scratch volume mount request denied - no scratch 
                         volume available. (SESSION: 8460)                        
12/11/12   23:09:57      ANR0522W Transaction failed for session 8460 for node     
                         ORAPROD (TDP Oracle AIX) - no space available in storage 
                         pool ORADBPOOL and all successor pools. (SESSION: 8460)  
12/11/12   23:09:57      ANR0403I Session 8460 ended for node ORAPROD (TDP Oracle  
                         AIX). (SESSION: 8460)                                           
...
</code></pre>
<h3>查看磁带状态</h3>
<p>q libvol 可查看当前在带库中注册的所有磁带的状态。</p>
<ul>
<li>Scratch表示此卷（磁带）已被回收，其内容被清除，且从存储池中注销，以备下次使用。</li>
<li>private表示此卷当前正在被使用。</li>
</ul>
<p>如下</p>
<pre><code>tsm: TSM&gt;q libvol

------------     -----------     ----------------     ----------     ---------     -------     ------
3573LIB          A00200L3        Private                             Data          4,096       LTO   
3573LIB          A00201L3        Private                             Data          4,098       LTO   
3573LIB          A00202L3        Private                             Data          4,100       LTO   
3573LIB          A00203L3        Private                             Data          4,097       LTO   
3573LIB          A00204L3        Private                             Data          4,099       LTO   
3573LIB          A00205L3        Private                             Data          4,105       LTO   
3573LIB          A00206L3        Private                             Data          4,104       LTO
</code></pre>
<p>q vol   可查看当前存储池中的卷的大小及状态。</p>
<ul>
<li>Full状态的卷在达到回收阙值后将会被回收。 </li>
</ul>
<p>如下</p>
<pre><code>tsm: TSM&gt;q vol

Volume Name                  Storage         Device         Estimated       Pct      Volume 
                             Pool Name       Class Name      Capacity      Util      Status 
------------------------     -----------     ----------     ---------     -----     --------
/usr/tivoli/tsm/server/-     ARCHIVEPOOL     DISK               8.0 M       0.0     On-Line 
 bin/archive.dsm                                                                            
/usr/tivoli/tsm/server/-     BACKUPPOOL      DISK               8.0 M       0.0     On-Line 
 bin/backup.dsm                                                                             
/usr/tivoli/tsm/server/-     SPACEMGPOOL     DISK               8.0 M       0.0     On-Line 
 bin/spcmgmt.dsm                                                                            
A00200L3                     ORADBPOOL       3573CLASS          1.5 T       5.1       Full  
A00201L3                     ORADBPOOL       3573CLASS          1.5 T      17.8       Full  
A00202L3                     ORADBPOOL       3573CLASS          1.5 T      15.0       Full  
A00203L3                     ORADBPOOL       3573CLASS          1.5 T      30.4       Full  
A00204L3                     ORADBPOOL       3573CLASS          1.5 T       3.1       Full  
A00205L3                     ORADBPOOL       3573CLASS          1.5 T      40.2     Filling 
A00206L3                     ORADBPOOL       3573CLASS          1.5 T      13.2       Full
</code></pre>
<h3>异常确认和处理</h3>
<p>发生如上错误的原因则是所有磁带均在存储池中处于Full的状态，导致带库中没有Scratch 状态的磁带用于备份导致。</p>
<p>此时可执行以下命令手动删除磁带中的内容，更改其状态为Scratch。</p>
<h4>q con</h4>
<ul>
<li>可查看该卷中的内容，判断其中内容是否可以删除。</li>
<li>一般如果卷中只有少量的备份或是测试环境数据，可以考虑清空。</li>
</ul>
<p>如下：</p>
<pre><code>tsm: TSM&gt;q con A00200L3

Node Name           Type     Filespace      FSID     Client's Name for File                
                             Name                    
---------------     ----     ----------     ----     --------------------------------------
ORATEST             Bkup     /adsmorc          2     // q4nk09k9_1_1
</code></pre>
<p>delete volume volumename DISCARDDATA=YES</p>
<p>删除一些测试环境备份卷中数据，执行后该卷将从存储池中注销，恢复状态为Scratch。该 环境汇中标为TEST的即为测试环境备份卷。</p>
<p>删除测试环境卷数据</p>
<pre><code>tsm: TSM&gt;delete volume A00200L3 DISCARDDATA=YES
ANR2221W This command will result in the deletion of all inventory references to the data on volume A00200L3, thereby rendering the data
unrecoverable.

Do you wish to proceed? (Yes (Y)/No (N)) Y
ANR2222I Discard Data process started for volume A00200L3 (process ID 40).
ANS8003I Process number 40 started.
</code></pre>
<p>查看删除后卷状态</p>
<pre><code>tsm: TSM&gt;q libvol
Library Name     Volume Name     Status               Owner          Last Use      Home        Device
                                                                                   Element     Type  
------------     -----------     ----------------     ----------     ---------     -------     ------
3573LIB          A00200L3        Scratch                                           4,096       LTO   
3573LIB          A00201L3        Private                             Data          4,098       LTO   
3573LIB          A00202L3        Private                             Data          4,100       LTO   
3573LIB          A00203L3        Private                             Data          4,097       LTO   
3573LIB          A00204L3        Private                             Data          4,099       LTO   
3573LIB          A00205L3        Private                             Data          4,105       LTO   
3573LIB          A00206L3        Private                             Data          4,104       LTO
</code></pre>
<p>适当删除一些测试环境的备份数据后，有足够的空间则可以正常完成备份任务。</p>
<h2>参考</h2>
<ul>
<li>IBM：IBM TSM backup case</li>
<li>IBM：IBM Tivoli Storage Management Concepts</li>
</ul> 
                </div>
        </div>
</div>

                                </div>
                        </div>
                </div>
        </div>
        <div id="footer">

        <div class="modal-footer">
                <p class="text-center">
                        Blog of <a href="/">dylan</a>.
                        Follow me on <a href="https://twitter.com/dylanninin" target="_blank">twitter</a>
                        or <a href="http://weibo.com/dylanninin" target="_blank">weibo</a>
                </p>
                <p class="text-center">
                        UI Designed by <a href="http://twitter.github.com/bootstrap" target="_blank">Twitter
                                Bootstrap</a>.
                        Powered by <a href="http://webpy.org" target="_blank">Web.py</a>.
                        Hosted by <a href="http://www.linode.com" target="_blank">Linode</a>.
                        Licensed under <a
                                href="http://creativecommons.org/licenses/by-nc-nd/3.0/" target="_blank">CC BY
                                3.0</a>
                </p>
                <p class="text-center">
                        Copyright &copy <a href="/">CLOUD</a> |
                        <a href="/about.html">About</a>
                </p>

        </div>
        <script src="/static/js/jquery.js"></script>
        <script src="/static/js/jquery-3.1.1.min.js"></script>
    <script src="/static/js/bootstrap.js"></script>
</div>

</body>
</html>
